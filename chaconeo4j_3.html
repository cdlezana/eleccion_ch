<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dashboard Electoral Chaco — V1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body { height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; }
    #app { display:flex; height:100vh; }
    #mapwrap { flex: 1 1 70%; position:relative; }
    #map { height:100%; width:100%; }
    #sidebar { width: 360px; min-width: 300px; max-width: 420px; background:#fff; border-left:1px solid #ddd; padding:12px; box-sizing:border-box; overflow:auto; }
    h2 { margin:6px 0 12px 0; font-size:18px; }
    .control-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .control-row select, .control-row input[type="text"], .control-row input[type="range"] { flex:1; padding:6px; font-size:14px; }
    .small { font-size:12px; color:#666; }
    .legend { background:white; padding:8px; border-radius:4px; box-shadow:0 1px 4px rgba(0,0,0,0.15); position:absolute; right:12px; bottom:12px; z-index:1000; max-width:220px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; }
    .panel-section { margin-top:12px; padding-top:8px; border-top:1px solid #eee; }
    #infoTitle { font-weight:700; margin-bottom:6px; }
    #topList { list-style:none; padding:0; margin:0; }
    #topList li { margin:4px 0; }
    button { padding:8px 10px; font-size:14px; cursor:pointer; }
    .muted { color:#666; font-size:13px; }
    .total3 { font-weight:700; margin-bottom:6px; }
  </style>
</head>
<body>
  <div id="app">
    <div id="mapwrap">
      <div id="map"></div>
      <div class="legend" id="legend"></div>
    </div>

    <div id="sidebar">
      <h2>Dashboard Electoral — Chaco</h2>

      <div class="control-row">
        <label style="width:80px;">Cargo:</label>
        <select id="cargoSelect">
          <option value="senador" selected>Senador</option>
          <option value="diputado">Diputado</option>
        </select>
      </div>

      <div class="control-row">
        <label style="width:80px;">Municipio:</label>
        <select id="searchSelect">
          <option value="">-- elegir municipio --</option>
        </select>
      </div>

      <div class="control-row">
        <label style="width:80px;">Filtro:</label>
        <select id="filtroFuerza">
          <option value="__ALL__">Todas las fuerzas</option>
        </select>
      </div>

      <div class="control-row">
        <label style="width:120px;">Mostrar vecinos</label>
        <input id="toggleVecinos" type="checkbox"/>
      </div>

      <div class="control-row">
        <label style="width:120px;">Radio vecinos (km)</label>
        <input id="radioVecinos" type="range" min="1" max="100" value="30"/>
        <span id="radioVal" class="small" style="width:40px;text-align:right">30</span>
      </div>

      <div class="panel-section">
        <div id="infoTitle">Haz click en un municipio</div>
        <div id="infoContent">
          <div id="infoCoords" class="muted">Lat / Lon</div>
          <div id="infoFuerza" style="margin-top:8px;"></div>
          <div id="infoVotos" style="margin-top:8px;"></div>
        </div>

        <div style="margin-top:12px;">
          <div class="total3" id="totalTop3">Total top 3: -</div>
          <canvas id="chartLocal" width="300" height="210"></canvas>
        </div>

        <div style="margin-top:10px;">
          <strong>Top Fuerzas (provincia)</strong>
          <ul id="provTop" class="muted"></ul>
        </div>
      </div>

      <div class="panel-section">
        <strong>Instrucciones</strong>
        <p class="small">Elegí cargo, seleccioná un municipio o haz click en el mapa. Activá "Mostrar vecinos" para ver la red (Haversine) — las líneas son más oscuras para mejor lectura.</p>
      </div>

      <div style="margin-top:12px;">
        <button id="resetView">Reset vista</button>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // ---------- CONFIG ----------
  const CSV_COORDS = "municipios_chaco.csv"; // has columns: municipio, lat, lon, ...
  const CSV_VOTOS = "query_munic_detalle_totales_fuerza_cargo_ign.csv"; // has rows per force: municipio, fuerza_politica, votos_senador, votos_diputado, votos_total

  const palette = {
    'FUERZA PATRIA': '#0044ff',
    'LA LIBERTAD AVANZA': '#ff0000',
    'FRENTE INTEGRADOR': '#008000',
    'UNIR': '#ffa500',
    'NEPAR': '#8a2be2',
    'PROYECTO SUR': '#228b22',
    'PARTIDO DEL OBRERO': '#cc0000',
    'VAMOS CHACO': '#1e90ff',
    'PARTIDO DIGNIDAD POPULAR': '#a0522d',
    'PARTIDO POLO SOCIAL MOVIMEN': '#ff69b4',
    'VOTOS EN BLANCO': '#999999',
    'VOTOS NULOS': '#666666',
    'VOTOS IMPUGNADOS': '#444444',
    'VOTOS RECURRIDOS': '#222222'
  };

  // ---------- UTIL ----------
  function haversineKm(aLat,aLon,bLat,bLon) {
    const R = 6371.0; // km
    const toRad = v => v * Math.PI/180;
    const dLat = toRad(bLat - aLat);
    const dLon = toRad(bLon - aLon);
    const la = toRad(aLat), lb = toRad(bLat);
    const sinDLat = Math.sin(dLat/2);
    const sinDLon = Math.sin(dLon/2);
    const x = sinDLat*sinDLat + Math.cos(la)*Math.cos(lb)*sinDLon*sinDLon;
    return 2*R*Math.asin(Math.sqrt(x));
  }

  // ---------- MAP ----------
  const map = L.map('map').setView([-27.5, -60.7], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);
  const edgesLayer = L.layerGroup().addTo(map);

  // state
  let municipios = [];       // array of {municipio, lat, lon, ...}
  let votosRaw = [];        // CSV_VOTOS rows
  let municipiosMap = {};   // municipio -> consolidated object { lat, lon, fuerzas: {name:{sen,dip,total}}, dominantSen, dominantDip, totalVotes }
  let markers = {};         // municipio -> marker
  let cargo = 'senador';
  let chartLocal = null;

  // dom
  const cargoSelect = document.getElementById('cargoSelect');
  const filtroFuerza = document.getElementById('filtroFuerza');
  const searchSelect = document.getElementById('searchSelect');
  const toggleVecinos = document.getElementById('toggleVecinos');
  const radioVecinos = document.getElementById('radioVecinos');
  const radioVal = document.getElementById('radioVal');
  const infoTitle = document.getElementById('infoTitle');
  const infoCoords = document.getElementById('infoCoords');
  const infoFuerza = document.getElementById('infoFuerza');
  const infoVotos = document.getElementById('infoVotos');
  const provTop = document.getElementById('provTop');
  const resetViewBtn = document.getElementById('resetView');
  const legendDiv = document.getElementById('legend');
  const totalTop3Div = document.getElementById('totalTop3');

  radioVal.innerText = radioVecinos.value;

  // ---------- LOAD both CSVs and merge ----------
  function loadAll() {
    Papa.parse(CSV_COORDS, {
      download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
      complete: function(res1) {
        municipios = res1.data.filter(r => r.municipio && r.lat && r.lon).map(r => ({ municipio: r.municipio, lat: parseFloat(r.lat), lon: parseFloat(r.lon) }));
        Papa.parse(CSV_VOTOS, {
          download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
          complete: function(res2) {
            votosRaw = res2.data;
            consolidate();
            buildUI();
            renderMarkers();
            buildLegend();
            buildProvTop();
            fitBoundsToMarkers();
            console.log('Cargado: municipios', municipios.length, 'votos filas', votosRaw.length);
          },
          error: function(e){ console.error('Error CSV VOTOS', e); alert('Error leyendo ' + CSV_VOTOS); }
        });
      },
      error: function(e){ console.error('Error CSV COORDS', e); alert('Error leyendo ' + CSV_COORDS); }
    });
  }

  // consolidate votosRaw and municipios into municipiosMap
  function consolidate() {
    municipiosMap = {};
    // init from coords
    municipios.forEach(m => {
      municipiosMap[m.municipio] = { municipio: m.municipio, lat: m.lat, lon: m.lon, fuerzas: {}, totalVotes: 0 };
    });
    // accumulate votes from votosRaw (rows per force)
    votosRaw.forEach(row => {
      const name = row.municipio;
      if(!name) return;
      if(!municipiosMap[name]) {
        // skip if we don't have coords (log)
        console.warn('Sin coordenadas para municipio:', name);
        return;
      }
      const f = row.fuerza_politica;
      const sen = Number(row.votos_senador) || 0;
      const dip = Number(row.votos_diputado) || 0;
      const tot = Number(row.votos_total) || (sen + dip);
      municipiosMap[name].fuerzas[f] = { sen, dip, tot };
      municipiosMap[name].totalVotes += tot;
    });

    // compute dominant by cargo
    Object.values(municipiosMap).forEach(m => {
      let domSen = null, domDip = null, maxSen = -1, maxDip = -1;
      Object.entries(m.fuerzas).forEach(([k,v]) => {
        if(v.sen > maxSen){ maxSen = v.sen; domSen = k; }
        if(v.dip > maxDip){ maxDip = v.dip; domDip = k; }
      });
      m.dominantSen = domSen;
      m.dominantDip = domDip;
    });
  }

  // ---------- UI population ----------
  function buildUI(){
    // municipio select
    searchSelect.innerHTML = '<option value="">-- elegir municipio --</option>';
    Object.keys(municipiosMap).sort().forEach(name => {
      const o = document.createElement('option'); o.value = name; o.text = name;
      searchSelect.appendChild(o);
    });
    searchSelect.addEventListener('change', e => {
      const val = e.target.value;
      if(val) selectMunicipio(municipiosMap[val]);
    });

    // filtro fuerzas (from votosRaw unique)
    const fuerzas = Array.from(new Set(votosRaw.map(r=>r.fuerza_politica).filter(Boolean))).sort();
    filtroFuerza.innerHTML = '<option value="__ALL__">Todas las fuerzas</option>';
    fuerzas.forEach(f => { const o = document.createElement('option'); o.value = f; o.text = f; filtroFuerza.appendChild(o); });

    // events
    cargoSelect.addEventListener('change', e => { cargo = e.target.value; refreshMarkers(); buildProvTop(); clearSelection(); });
    filtroFuerza.addEventListener('change', refreshMarkers);
    toggleVecinos.addEventListener('change', () => drawEdges());
    radioVecinos.addEventListener('input', e => { radioVal.innerText = e.target.value; if(toggleVecinos.checked) drawEdges(); });
    resetViewBtn.addEventListener('click', () => map.setView([-27.5,-60.7],7));
  }

  function colorFor(mObj) {
    const f = (cargo === 'senador') ? mObj.dominantSen : mObj.dominantDip;
    return palette[f] || '#888';
  }

  // ---------- MARKERS ----------
  function renderMarkers(){
    markersLayer.clearLayers();
    markers = {};
    Object.values(municipiosMap).forEach(m => {
      // filter by filtroFuerza if any (based on selected cargo)
      const filtro = filtroFuerza.value;
      const curF = (cargo==='senador') ? m.dominantSen : m.dominantDip;
      if(filtro !== '__ALL__' && filtro !== curF) return;

      const marker = L.circleMarker([m.lat, m.lon], {
        radius: 6, fillColor: colorFor(m), color: '#000', weight: 0.8, fillOpacity: 0.95
      }).addTo(markersLayer);
      marker.on('click', () => selectMunicipio(m));
      marker.bindTooltip(m.municipio, {permanent:false, direction:'top', offset:[0,-8]});
      markers[m.municipio] = marker;
    });
  }

  function refreshMarkers(){
    // just re-render for simplicity (keeps code clear)
    renderMarkers();
    if(toggleVecinos.checked) drawEdges();
  }

  function clearSelection() {
    infoTitle.innerText = 'Haz click en un municipio';
    infoCoords.innerText = '';
    infoFuerza.innerText = '';
    infoVotos.innerText = '';
    totalTop3Div.innerText = 'Total top 3: -';
    if(chartLocal){ chartLocal.destroy(); chartLocal = null; }
    edgesLayer.clearLayers();
  }

  // ---------- SELECT & DETAILS ----------
  function selectMunicipio(m) {
    if(!m) return;
    map.setView([m.lat,m.lon], 11, {animate:true});
    infoTitle.innerText = m.municipio;
    infoCoords.innerText = `Lat: ${m.lat.toFixed(6)}  Lon: ${m.lon.toFixed(6)}`;
    const f = (cargo==='senador') ? m.dominantSen : m.dominantDip;
    infoFuerza.innerHTML = `<strong>${cargo.toUpperCase()}</strong>: ${f || 'Sin dato'}`;
    infoVotos.innerHTML = `<div class="small">Votos totales (suma filas): ${m.totalVotes}</div>`;

    buildLocalChart(m);
    if(toggleVecinos.checked) drawEdges(m);
  }

  // ---------- PROVINCIAL TOP ----------
  function buildProvTop() {
    // aggregate total by force for selected cargo using total of municipalities where that force is dominant? or sum votes across municipios?
    // We'll count number of municipios dominated by each force (like prior behavior)
    const totals = {};
    Object.values(municipiosMap).forEach(m => {
      const key = (cargo==='senador') ? m.dominantSen : m.dominantDip;
      if(!key) return;
      totals[key] = (totals[key]||0) + 1;
    });
    const arr = Object.entries(totals).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
    provTop.innerHTML = '';
    arr.slice(0,8).forEach(x => {
      const li = document.createElement('li');
      li.innerText = `${x.k}: ${x.v} municipios`;
      li.style.color = palette[x.k] || '#000';
      provTop.appendChild(li);
    });
  }

  // ---------- LOCAL chart (top 3 real votes) ----------
  function buildLocalChart(m) {
    // build array of forces with votes for the chosen cargo
    const arr = Object.entries(m.fuerzas).map(([k,v]) => {
      return { name: k, votes: (cargo==='senador') ? v.sen : v.dip };
    }).sort((a,b) => b.votes - a.votes);

    const top3 = arr.slice(0,3);
    const labels = top3.map(x => x.name || 'Sin dato');
    const data = top3.map(x => x.votes || 0);
    const total3 = data.reduce((s,n)=>s+n,0);

    totalTop3Div.innerText = `Total top 3: ${total3.toLocaleString()}`;

    // destroy previous
    if(chartLocal) chartLocal.destroy();
    const ctx = document.getElementById('chartLocal').getContext('2d');
    chartLocal = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Votos', data, backgroundColor: labels.map(l=>palette[l]||'#888') }] },
      options: { responsive:true, maintainAspectRatio:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ---------- EDGES (vecinos calculados en cliente) ----------
  function drawEdges(selected=null) {
    edgesLayer.clearLayers();
    if(!toggleVecinos.checked) return;
    const radiusKm = parseFloat(radioVecinos.value);
    // style: darker, thicker as requested
    const styleAll = { color: '#333333', weight: 2.5, opacity: 0.85 };
    const styleSelected = { color: '#333333', weight: 3, opacity: 0.95 };

    if(selected) {
      Object.values(municipiosMap).forEach(o => {
        if(o.municipio === selected.municipio) return;
        const d = haversineKm(selected.lat, selected.lon, o.lat, o.lon);
        if(d <= radiusKm) {
          L.polyline([[selected.lat, selected.lon],[o.lat,o.lon]], styleSelected).addTo(edgesLayer);
        }
      });
    } else {
      // all pairs, but skip duplicates
      const arr = Object.values(municipiosMap);
      for(let i=0;i<arr.length;i++){
        for(let j=i+1;j<arr.length;j++){
          const a = arr[i], b = arr[j];
          const d = haversineKm(a.lat,a.lon,b.lat,b.lon);
          if(d <= radiusKm) {
            L.polyline([[a.lat,a.lon],[b.lat,b.lon]], styleAll).addTo(edgesLayer);
          }
        }
      }
    }
  }

  // ---------- Search by select handled earlier ----------
  // ---------- Misc ----------
  map.on('click', e => { /* optional: clearSelection(); */ });

  function fitBoundsToMarkers() {
    const latlngs = Object.values(municipiosMap).map(m => [m.lat,m.lon]);
    if(latlngs.length>0) map.fitBounds(latlngs, {padding:[30,30]});
  }

  // ---------- Legend ----------
  function buildLegend() {
    legendDiv.innerHTML = '<strong style="display:block;margin-bottom:6px">Leyenda (colores)</strong>';
    Object.keys(palette).slice(0,10).forEach(k => {
      const row = document.createElement('div'); row.className='item';
      const dot = document.createElement('span'); dot.className='dot'; dot.style.background = palette[k];
      row.appendChild(dot);
      const txt = document.createElement('span'); txt.innerText = k;
      row.appendChild(txt);
      legendDiv.appendChild(row);
    });
  }

  // ---------- Start ----------
  loadAll();

  </script>
</body>
</html>
