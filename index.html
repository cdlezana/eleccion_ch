<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dashboard Electoral Chaco — GOLDEN MASTER (fixes)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #app{display:flex;height:100vh}
    #mapwrap{flex:1 1 70%;position:relative}
    #map{height:100%;width:100%}
    #sidebar{width:380px;min-width:300px;background:#fff;border-left:1px solid #ddd;padding:12px;box-sizing:border-box;overflow:auto}
    h2{margin:6px 0 12px 0;font-size:18px}
    .control-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .control-row select,.control-row input[type="range"]{flex:1;padding:6px;font-size:14px}
    .small{font-size:12px;color:#666}
    .legend{background:white;padding:8px;border-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,0.15);position:absolute;right:12px;bottom:12px;z-index:1000;max-width:260px}
    .legend .item{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .dot{width:14px;height:14px;border-radius:50%;display:inline-block}
    .panel-section{margin-top:12px;padding-top:8px;border-top:1px solid #eee}
    #infoTitle{font-weight:700;margin-bottom:6px}
    button{padding:8px 10px;font-size:14px;cursor:pointer}
    .muted{color:#666;font-size:13px}
    .total3{font-weight:700;margin-bottom:6px}
    .highlight { outline: 3px solid rgba(0,0,0,0.04); padding:6px; border-radius:4px; background:#fafafa; }
  </style>
</head>
<body>
  <div id="app">
    <div id="mapwrap">
      <div id="map"></div>
      <div class="legend" id="legend"></div>
    </div>

    <div id="sidebar">
      <h2>Dashboard Electoral — Chaco</h2>

      <div class="control-row">
        <label style="width:80px;">Cargo:</label>
        <select id="cargoSelect">
          <option value="senador">Senador</option>
          <option value="diputado" selected>Diputado</option>
        </select>
      </div>

      <div class="control-row">
        <label style="width:80px;">Municipio:</label>
        <select id="searchSelect"><option value="">-- (ninguno) mostrar Provincial --</option></select>
      </div>

      <div class="control-row">
        <label style="width:80px;">Filtro:</label>
        <select id="filtroFuerza"><option value="__ALL__">Todas las fuerzas</option></select>
      </div>

      <div class="control-row">
        <label style="width:120px;">Mostrar vecinos</label>
        <input id="toggleVecinos" type="checkbox"/>
      </div>

      <div class="control-row">
        <label style="width:120px;">Radio vecinos (km)</label>
        <input id="radioVecinos" type="range" min="1" max="100" value="30"/>
        <span id="radioVal" class="small" style="width:40px;text-align:right">30</span>
      </div>

      <div class="panel-section highlight">
        <div id="infoTitle">Haz click en un municipio o deja (ninguno) para ver provincial</div>
        <div id="infoContent">
          <div id="infoCoords" class="muted">Lat / Lon</div>
          <div id="infoFuerza" style="margin-top:8px;"></div>
          <div id="infoVotos" style="margin-top:8px;"></div>
        </div>

        <div style="margin-top:12px;">
          <div class="total3" id="totalTop3">Total top 3: -</div>
          <canvas id="chartLocal" width="320" height="240"></canvas>
        </div>

        <div style="margin-top:10px;">
          <strong>Top Fuerzas (por municipios dominados)</strong>
          <ul id="provTop" class="muted"></ul>
        </div>
      </div>

      <div class="panel-section">
        <strong>Instrucciones</strong>
        <p class="small">Elegí cargo, seleccioná un municipio (o ninguno para ver provincial). Activá "Mostrar vecinos" para ver la red (Haversine).</p>
      </div>

      <div style="margin-top:12px;">
        <button id="resetView">Reset vista</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // ---------- FILES ----------
  const CSV_COORDS = "municipios_chaco.csv";
  const CSV_VOTOS = "query_munic_detalle_totales_fuerza_cargo_ign.csv";

  // ---------- COLORS (confirmed; VAMOS CHACO changed) ----------
  const palette = {
    'FUERZA PATRIA': '#005BBB',
    'LA LIBERTAD AVANZA': '#7a1fa2',
    'FRENTE INTEGRADOR': '#2e7d32',
    'UNIR': '#ff9800',
    'NEPAR': '#8d6e63',
    'PROYECTO SUR': '#1976d2',
    'PARTIDO DEL OBRERO': '#c62828',
    'VAMOS CHACO': '#00BFA5',               // changed: teal / distinto del morado
    'PARTIDO DIGNIDAD POPULAR': '#9e9d24',
    'PARTIDO POLO SOCIAL MOVIMEN': '#6d4c41',
    'VOTOS EN BLANCO': '#95A5A6',
    'VOTOS IMPUGNADOS': '#7F8C8D',
    'VOTOS NULOS': '#34495E',
    'VOTOS RECURRIDOS': '#566573'
  };

  // Exclude list (never shown on map or chart) - uppercased for case-insensitive compare
  const EXCLUDE_FORZAS = new Set(['TOTALES','VOTOS EN BLANCO','VOTOS IMPUGNADOS','VOTOS NULOS','VOTOS RECURRIDOS'].map(s=>s.toUpperCase()));

  // ---------- UTIL ----------
  function haversineKm(aLat,aLon,bLat,bLon) {
    const R = 6371.0;
    const toRad = v => v * Math.PI/180;
    const dLat = toRad(bLat - aLat);
    const dLon = toRad(bLon - aLon);
    const la = toRad(aLat), lb = toRad(bLat);
    const sinDLat = Math.sin(dLat/2);
    const sinDLon = Math.sin(dLon/2);
    const x = sinDLat*sinDLat + Math.cos(la)*Math.cos(lb)*sinDLon*sinDLon;
    return 2*R*Math.asin(Math.sqrt(x));
  }

  // ---------- MAP ----------
  const map = L.map('map').setView([-27.5, -60.7], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);
  const edgesLayer = L.layerGroup().addTo(map);

  // ---------- STATE ----------
  let rawCoords = [];
  let rawVotos = [];
  let municipiosMap = {};    // municipio -> { municipio, lat, lon, fuerzas:{name:{sen,dip,tot}}, totalVotes, dominantSen, dominantDip }
  let markers = {};
  let cargo = 'diputado';
  let chartLocal = null;

  // DOM
  const cargoSelect = document.getElementById('cargoSelect');
  const filtroFuerza = document.getElementById('filtroFuerza');
  const searchSelect = document.getElementById('searchSelect');
  const toggleVecinos = document.getElementById('toggleVecinos');
  const radioVecinos = document.getElementById('radioVecinos');
  const radioVal = document.getElementById('radioVal');
  const infoTitle = document.getElementById('infoTitle');
  const infoCoords = document.getElementById('infoCoords');
  const infoFuerza = document.getElementById('infoFuerza');
  const infoVotos = document.getElementById('infoVotos');
  const provTop = document.getElementById('provTop');
  const resetViewBtn = document.getElementById('resetView');
  const legendDiv = document.getElementById('legend');
  const totalTop3Div = document.getElementById('totalTop3');

  radioVal.innerText = radioVecinos.value;

  // ---------- LOAD CSVs ----------
  function loadAll(){
    Papa.parse(CSV_COORDS, { download:true, header:true, skipEmptyLines:true, complete: res => {
      rawCoords = res.data.filter(r => r.municipio && r.lat && r.lon);
      rawCoords.forEach(r=>{ r.municipio = String(r.municipio).trim(); r.lat = parseFloat(r.lat); r.lon = parseFloat(r.lon); });
      Papa.parse(CSV_VOTOS, { download:true, header:true, skipEmptyLines:true, complete: res2 => {
        rawVotos = res2.data.map(r => {
          if(r.municipio) r.municipio = String(r.municipio).trim();
          if(r.fuerza_politica) r.fuerza_politica = String(r.fuerza_politica).trim();
          return r;
        });
        consolidate();
        buildUI();
        renderMarkers();
        buildLegend();
        buildProvTop();
        fitBoundsToMarkers();
        // initial provincial chart
        buildProvAggregateChart();
        console.log('Cargado: coords', rawCoords.length, 'votos filas', rawVotos.length);
      }, error: e => { console.error('Error VOTOS', e); alert('Error leyendo votos: '+(e.message||e)); }});
    }, error: e => { console.error('Error COORDS', e); alert('Error leyendo coords: '+(e.message||e)); }});
  }

  // ---------- CONSOLIDATE ----------
  function consolidate(){
    municipiosMap = {};
    rawCoords.forEach(r => {
      municipiosMap[r.municipio] = { municipio: r.municipio, lat: r.lat, lon: r.lon, fuerzas: {}, totalVotes: 0 };
    });

    rawVotos.forEach(row => {
      const name = row.municipio;
      if(!name) return;
      if(!municipiosMap[name]) {
        console.warn('Sin coordenadas para municipio:', name);
        return;
      }
      const fuerza = row.fuerza_politica ? String(row.fuerza_politica).trim() : null;
      if(!fuerza) return;
      if(EXCLUDE_FORZAS.has(fuerza.toUpperCase())) return; // skip totals / blancos / nulos...
      const sen = Number(row.votos_senador) || 0;
      const dip = Number(row.votos_diputado) || 0;
      const tot = Number(row.votos_total) || (sen + dip);
      municipiosMap[name].fuerzas[fuerza] = { sen, dip, tot };
      municipiosMap[name].totalVotes += tot; // sum only non-excluded forces
    });

    // compute dominants
    Object.values(municipiosMap).forEach(m => {
      let maxSen=-1, maxDip=-1, domSen=null, domDip=null;
      Object.entries(m.fuerzas).forEach(([k,v])=>{
        if(v.sen > maxSen){ maxSen = v.sen; domSen = k; }
        if(v.dip > maxDip){ maxDip = v.dip; domDip = k; }
      });
      m.dominantSen = domSen;
      m.dominantDip = domDip;
    });
  }

  // ---------- UI ----------
  function buildUI(){
    // municipio selector
    searchSelect.innerHTML = '<option value="">-- (ninguno) mostrar Provincial --</option>';
    Object.keys(municipiosMap).sort().forEach(name=>{
      const o = document.createElement('option'); o.value = name; o.text = name; searchSelect.appendChild(o);
    });
    searchSelect.addEventListener('change', e => {
      const val = e.target.value;
      if(val) selectMunicipio(municipiosMap[val]);
      else { clearSelection(); buildProvAggregateChart(); }
    });

    // filtro fuerzas dynamic
    const fuerzasSet = new Set();
    rawVotos.forEach(r => {
      if(!r.fuerza_politica) return;
      if(EXCLUDE_FORZAS.has(r.fuerza_politica.toUpperCase())) return;
      fuerzasSet.add(r.fuerza_politica.trim());
    });
    const fuerzas = Array.from(fuerzasSet).sort();
    filtroFuerza.innerHTML = '<option value="__ALL__">Todas las fuerzas</option>';
    fuerzas.forEach(f => { const o=document.createElement('option'); o.value=f; o.text=f; filtroFuerza.appendChild(o); });

    // events
    cargoSelect.addEventListener('change', e => { cargo = e.target.value; refreshAllOnCargoChange(); });
    filtroFuerza.addEventListener('change', refreshMarkers);
    toggleVecinos.addEventListener('change', () => drawEdges());
    radioVecinos.addEventListener('input', e => { radioVal.innerText = e.target.value; if(toggleVecinos.checked) drawEdges(); });
    resetViewBtn.addEventListener('click', () => map.setView([-27.5,-60.7],7));
  }

  // ---------- MARKERS ----------
  function colorFor(mObj) {
    const f = (cargo==='senador') ? mObj.dominantSen : mObj.dominantDip;
    return palette[f] || '#888';
  }

  function renderMarkers(){
    markersLayer.clearLayers();
    markers = {};
    Object.values(municipiosMap).forEach(m=>{
      const filtro = filtroFuerza.value;
      const curF = (cargo==='senador') ? m.dominantSen : m.dominantDip;
      if(filtro !== '__ALL__' && filtro !== curF) return;
      const marker = L.circleMarker([m.lat,m.lon], {
        radius: 6, fillColor: colorFor(m), color:'#000', weight:0.9, fillOpacity:0.95
      }).addTo(markersLayer);
      marker.on('click', ()=> {
        selectMunicipio(m);
        // sync selector
        searchSelect.value = m.municipio;
      });
      marker.bindTooltip(m.municipio,{permanent:false,direction:'top',offset:[0,-8]});
      markers[m.municipio] = marker;
    });
  }

  // ---------- REFRESH WHEN CARGO CHANGES ----------
  function refreshAllOnCargoChange(){
    clearSelection();
    renderMarkers();
    buildLegend();
    buildProvTop();
    // if no municipio selected show provincial chart
    if(!searchSelect.value) buildProvAggregateChart();
    if(toggleVecinos.checked) drawEdges();
  }

  function clearSelection(){
    infoTitle.innerText = 'Haz click en un municipio o deja (ninguno) para ver provincial';
    infoCoords.innerText = '';
    infoFuerza.innerHTML = '';
    infoVotos.innerHTML = '';
    totalTop3Div.innerText = 'Total top 3: -';
    if(chartLocal){ chartLocal.destroy(); chartLocal = null; }
    edgesLayer.clearLayers();
  }

  // ---------- SELECT MUNICIPIO ----------
  function selectMunicipio(m){
    if(!m) return;
    map.setView([m.lat,m.lon],11,{animate:true});
    infoTitle.innerText = m.municipio;
    infoCoords.innerText = `Lat: ${m.lat.toFixed(6)}  Lon: ${m.lon.toFixed(6)}`;
    const f = (cargo==='senador') ? m.dominantSen : m.dominantDip;
    infoFuerza.innerHTML = `<strong>${cargo.toUpperCase()}</strong>: ${f || 'Sin dato'}`;
    // totalVotes already computed excluding TOTALES
    infoVotos.innerHTML = `<div class="small">Votos totales (suma filas válidas): ${(m.totalVotes / 2).toLocaleString()}</div>`;
    buildLocalChart(m);
    if(toggleVecinos.checked) drawEdges(m);
  }

  // ---------- PROVINCIAL TOP (dominance count) ----------
  function buildProvTop(){
    const totals = {};
    Object.values(municipiosMap).forEach(m => {
      const key = (cargo==='senador') ? m.dominantSen : m.dominantDip;
      if(!key) return;
      totals[key] = (totals[key]||0)+1;
    });
    const arr = Object.entries(totals).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
    provTop.innerHTML='';
    arr.slice(0,10).forEach(x=>{
      const li=document.createElement('li');
      li.innerText = `${x.k}: ${x.v} municipios`;
      li.style.color = palette[x.k] || '#000';
      provTop.appendChild(li);
    });
  }

  // ---------- CHART: top3 per municipality OR provincial aggregate if none selected ----------
  function buildLocalChart(m){
    // if m provided => show top3 of that municipality
    // if null => show top3 aggregated provincial for selected cargo
    let arrSorted;
    if(m){
      arrSorted = Object.entries(m.fuerzas).map(([k,v]) => ({ name:k, votes:(cargo==='senador')?v.sen:v.dip })).sort((a,b)=>b.votes - a.votes);
    } else {
      // aggregate across municipiosMap
      const agg = {};
      Object.values(municipiosMap).forEach(mm => {
        Object.entries(mm.fuerzas).forEach(([k,v])=>{
          if(!agg[k]) agg[k]=0;
          agg[k] += (cargo==='senador')?v.sen:v.dip;
        });
      });
      arrSorted = Object.entries(agg).map(([k,v])=>({ name:k, votes:v })).sort((a,b)=>b.votes - a.votes);
    }

    const top3 = arrSorted.slice(0,3);
    const labels = top3.map(x=>x.name);
    const data = top3.map(x=>x.votes);
    const colors = top3.map(x => palette[x.name] || '#888');

    const total3 = data.reduce((s,n)=>s+n,0);
    totalTop3Div.innerText = `Total top 3: ${total3.toLocaleString()}`;

    if(chartLocal) chartLocal.destroy();
    const ctx = document.getElementById('chartLocal').getContext('2d');
    chartLocal = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ label:'Votos', data, backgroundColor: colors }] },
      options: { responsive:true, maintainAspectRatio:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ---------- EDGES ----------
  function drawEdges(selected=null){
    edgesLayer.clearLayers();
    if(!toggleVecinos.checked) return;
    const radiusKm = parseFloat(radioVecinos.value);
    const styleAll = { color:'#333333', weight:2.6, opacity:0.88 };
    const styleSelected = { color:'#222222', weight:3.2, opacity:0.98 };

    if(selected){
      Object.values(municipiosMap).forEach(o=>{
        if(o.municipio===selected.municipio) return;
        const d = haversineKm(selected.lat,selected.lon,o.lat,o.lon);
        if(d<=radiusKm) L.polyline([[selected.lat,selected.lon],[o.lat,o.lon]], styleSelected).addTo(edgesLayer);
      });
    } else {
      const arr = Object.values(municipiosMap);
      for(let i=0;i<arr.length;i++){
        for(let j=i+1;j<arr.length;j++){
          const a=arr[i], b=arr[j];
          const d = haversineKm(a.lat,a.lon,b.lat,b.lon);
          if(d<=radiusKm) L.polyline([[a.lat,a.lon],[b.lat,b.lon]], styleAll).addTo(edgesLayer);
        }
      }
    }
  }

  // ---------- LEGEND dynamic (dominants present) ----------
  

  // ---------- LEGEND dynamic (dominantes presentes) ----------
  function buildLegend() {
    legendDiv.innerHTML = `
      <strong style="display:block;margin-bottom:6px">
        Leyenda (dominantes)
      </strong>
    `;

    const presentes = new Set();

    Object.values(municipiosMap).forEach(m => {
      const dom = (cargo === 'senador') ? m.dominantSen : m.dominantDip;
      if (dom) presentes.add(dom);
    });

    const lista = Array.from(presentes).sort();

    if (lista.length === 0) {
      legendDiv.innerHTML += `<div class="small">No hay datos dominantes</div>`;
      return;
    }

    lista.forEach(f => {
      const row = document.createElement('div');
      row.className = 'item';

      const dot = document.createElement('span');
      dot.className = 'dot';
      dot.style.background = palette[f] || '#888';

      const txt = document.createElement('span');
      txt.innerText = f;

      row.appendChild(dot);
      row.appendChild(txt);
      legendDiv.appendChild(row);
    });
  }





  // ---------- REFRESH MARKERS ----------
  function refreshMarkers(){
    renderMarkers();
    if(toggleVecinos.checked) drawEdges();
  }

  // ---------- FIT BOUNDS ----------
  function fitBoundsToMarkers(){
    const latlngs = Object.values(municipiosMap).map(m=>[m.lat,m.lon]);
    if(latlngs.length>0) map.fitBounds(latlngs,{padding:[20,20]});
  }

  // ---------- Provincial aggregate chart (called when no municipality selected) ----------
  function buildProvAggregateChart(){
    buildLocalChart(null);
  }

  // ---------- START ----------
  loadAll();

  </script>
</body>
</html>
